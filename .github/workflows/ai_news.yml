name: AI News Pro Summarizer

on:
  schedule:
    - cron: '0 1 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 è¿è¡Œ
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests beautifulsoup4

      - name: Run News Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os
          from bs4 import BeautifulSoup

          # 1. ç›‘æ§å¤šä¸ªé¡¶çº§ AI èµ„è®¯æº
          sources = [
              "https://www.theverge.com/ai-artificial-intelligence/rss/index.xml",
              "https://techcrunch.com/category/artificial-intelligence/feed/",
              "https://openai.com/news/rss.xml"
          ]
          
          all_entries = []
          for url in sources:
              try:
                  feed = feedparser.parse(url)
                  if feed.entries:
                      # æ¯ä¸ªæºåªå–æœ€æ–°çš„ 2 æ¡ï¼Œä¿è¯å†…å®¹å¤šæ ·æ€§
                      all_entries.extend(feed.entries[:2])
              except:
                  continue

          if not all_entries:
              requests.post(os.environ['WECHAT_WEBHOOK'], json={"msgtype": "text", "text": {"content": "ğŸ¤– AIæƒ…æŠ¥å‘˜ï¼šå…¨ç½‘æœå¯»å®Œæ¯•ï¼Œå½“å‰æš‚æ— é‡å¤§æ–°åŠ¨æ€ã€‚"}})
              exit()

          # 2. å‡†å¤‡æ¨é€
          final_message = "ğŸš€ **AI è¡Œä¸šæ·±åº¦å†…å‚ (å¤šæºèšåˆç‰ˆ)**\n\n"

          # 3. å¤„ç†å‰ 4 æ¡æœ€é‡è¦çš„æ–°é—»ï¼Œé˜²æ­¢æ¶ˆæ¯è¿‡é•¿
          for entry in all_entries[:4]:
              title_en = entry.title
              summary_en = BeautifulSoup(entry.get('summary', 'No summary'), "html.parser").get_text()[:300]
              link = entry.link
              
              try:
                  resp = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {os.environ['AI_API_KEY']}"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [
                              {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘æŠ€ä¸»ç¼–ã€‚è¯·æ ¹æ®æä¾›çš„ AI æ–°é—»æ ‡é¢˜å’Œæ‘˜è¦ï¼Œåˆ›ä½œä¸€ä¸ªå¸å¼•äººçš„ä¸­æ–‡æ ‡é¢˜ï¼Œå¹¶ç”¨ 3 ä¸ªè¦ç‚¹æ€»ç»“æ ¸å¿ƒä»·å€¼ã€‚æ’ç‰ˆè¦æ±‚ï¼šç¬¬ä¸€è¡Œæ˜¯åŠ ç²—æ ‡é¢˜ï¼Œæ¥ä¸‹æ¥æ˜¯ 3 ä¸ªå¸¦ç¬¦å·çš„è¦ç‚¹ã€‚"},
                              {"role": "user", "content": f"Title: {title_en}\nSummary: {summary_en}"}
                          ]
                      },
                      timeout=30
                  )
                  ai_result = resp.json()['choices'][0]['message']['content']
              except:
                  ai_result = f"**{title_en}**\n(ç¿»è¯‘åŠæ€»ç»“æš‚æ—¶ç¦»çº¿)"

              final_message += f"{ai_result}\nğŸ”— [é˜…è¯»åŸæ–‡]({link})\n\n---\n"

          # 4. å‘é€
          requests.post(
              os.environ['WECHAT_WEBHOOK'],
              json={"msgtype": "markdown", "markdown": {"content": final_message}}
          )
          EOF
