name: AI News Tools & Courses Pro

on:
  schedule:
    - cron: '18 0 * * *' 
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests beautifulsoup4

      - name: Run AI Tool Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          # æ³¨æ„ï¼šä¸‹é¢è¿™ä¸€è¡Œæ”¹æˆäº† <<'EOF'ï¼Œé˜²æ­¢ Bash è§£æå†…éƒ¨ç¬¦å·
          python - <<'EOF'
          import feedparser
          import requests
          import os
          import sys
          from bs4 import BeautifulSoup

          webhook = os.environ.get('WECHAT_WEBHOOK')
          api_key = os.environ.get('AI_API_KEY')
          
          if not webhook or not api_key:
              print("é”™è¯¯: ç¼ºå°‘é…ç½®å˜é‡ WECHAT_WEBHOOK æˆ– AI_API_KEY")
              sys.exit(1)

          headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}
          sources = [
              "https://rsshub.app/deeplearning/the-batch",
              "https://huggingface.co/blog/feed.xml",
              "https://www.unite.ai/category/ai-tools/feed/",
              "https://blog.langchain.dev/rss/"
          ]
          
          keywords = ['course', 'tool', 'library', 'guide', 'tutorial', 'open source', 'release', 'framework', 'agent', 'workflow', 'model']
          all_entries = []

          print("å¼€å§‹æŠ“å–èµ„è®¯...")
          for url in sources:
              try:
                  resp = requests.get(url, headers=headers, timeout=20)
                  feed = feedparser.parse(resp.text)
                  if not feed.entries: continue
                  
                  count = 0
                  for entry in feed.entries:
                      content = (entry.title + entry.get('summary', '')).lower()
                      if any(kw in content for kw in keywords) or "huggingface" in url or "deeplearning" in url:
                          all_entries.append(entry)
                          count += 1
                      if count >= 2: break
              except Exception as e:
                  print(f"æŠ“å–å¤±è´¥ {url}: {e}")

          if not all_entries:
              print("æœªå‘ç°åŒ¹é…å†…å®¹ï¼Œç»“æŸè¿è¡Œã€‚")
              sys.exit(0)

          final_message = "ğŸ› ï¸ AI å®æˆ˜è¿›é˜¶ & å®ç”¨å·¥å…·å‘¨æŠ¥\n\n"

          for entry in all_entries[:4]:
              title_en = entry.title
              summary_en = BeautifulSoup(entry.get('summary', 'No summary'), "html.parser").get_text()[:500]
              
              try:
                  resp = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {api_key}"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [
                              {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ AI æŠ€æœ¯æ•™ç»ƒã€‚è¯·å°† AI å†…å®¹ç¿»è¯‘æ€»ç»“ã€‚é‡ç‚¹ï¼š1.å·¥å…·/è¯¾ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ2.è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ3.é€‚åˆè°ã€‚ä¸¥ç¦ Markdown ç¬¦å·ã€‚"},
                              {"role": "user", "content": f"Title: {title_en}\nSummary: {summary_en}"}
                          ]
                      },
                      timeout=30
                  )
                  if resp.status_code == 200:
                      ai_result = resp.json()['choices'][0]['message']['content']
                      # è¿™é‡Œå°±æ˜¯ä¹‹å‰å¯¼è‡´æŠ¥é”™çš„ç¬¦å·ï¼ŒåŠ äº†å•å¼•å·åå°±ä¸ä¼šæœ‰å†²çªäº†
                      ai_result = ai_result.replace("**", "").replace("### ", "").replace("# ", "").replace("`", "")
                  else:
                      ai_result = f"é¡¹ç›®: {title_en}\n(AI æ¥å£å“åº”å¼‚å¸¸: {resp.status_code})"
              except Exception as e:
                  ai_result = f"é¡¹ç›®: {title_en}\n(AI æ€»ç»“å¤±è´¥: {e})"

              final_message += f"{ai_result.strip()}\nğŸ”— é“¾æ¥: {entry.link}\n\n----------------\n"

          try:
              requests.post(webhook, json={"msgtype": "text", "text": {"content": final_message}}, timeout=10)
              print("æ¨é€å®Œæˆï¼")
          except Exception as e:
              print(f"æ¨é€å¤±è´¥: {e}")
              sys.exit(1)
          EOF
