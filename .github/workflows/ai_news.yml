name: AI News Tools & Courses Pro

on:
  schedule:
    - cron: '26 0 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8:30 è¿è¡Œ
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæµ‹è¯•

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests beautifulsoup4

      - name: Run AI Tool Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os
          import re
          from bs4 import BeautifulSoup

          # 1. ç­›é€‰é«˜è´¨é‡çš„å®æˆ˜ç±»ä¸å·¥å…·ç±»ä¿¡æ¯æº
          sources = [
              "https://rsshub.app/deeplearning/the-batch",     # DeepLearning.AI (å´æ©è¾¾å‘¨æŠ¥)
              "https://huggingface.co/blog/feed.xml",          # Hugging Face (æ¨¡å‹ä¸å·¥å…·å‘å¸ƒ)
              "https://www.unite.ai/category/ai-tools/feed/",  # ä¸“é—¨çš„ AI å·¥å…·è¯„æµ‹
              "https://blog.langchain.dev/rss/",                # LangChain å®˜æ–¹åšå®¢ (å®æˆ˜æ¡ˆä¾‹)
              "https://github.com/trending/python?since=daily" # GitHub è¶‹åŠ¿ (é€šè¿‡ Python æŠ“å–é€»è¾‘é—´æ¥å®ç°æˆ–åç»­æ‰©å±•)
          ]
          
          # æ ¸å¿ƒå…³é”®è¯è¿‡æ»¤ï¼Œç¡®ä¿å†…å®¹åå‘â€œå®ç”¨â€å’Œâ€œå­¦ä¹ â€
          keywords = ['course', 'tool', 'library', 'guide', 'tutorial', 'open source', 'release', 'framework', 'agent', 'workflow', 'model']

          all_entries = []
          for url in sources:
              try:
                  feed = feedparser.parse(url)
                  if not feed.entries: continue
                  
                  source_count = 0
                  for entry in feed.entries:
                      content = (entry.title + entry.get('summary', '')).lower()
                      # å¦‚æœåŒ¹é…åˆ°å…³é”®è¯ï¼Œæˆ–è€…æ˜¯æ¥è‡ª DeepLearning.AI/HuggingFace çš„å†…å®¹ï¼Œåˆ™ä¼˜å…ˆé€‰å–
                      if any(kw in content for kw in keywords) or "huggingface" in url or "deeplearning" in url:
                          all_entries.append(entry)
                          source_count += 1
                      if source_count >= 2: break # æ¯ä¸ªæºæœ€å¤šå– 2 æ¡æœ€ç›¸å…³çš„
              except Exception as e:
                  print(f"æŠ“å– {url} å¤±è´¥: {e}")
                  continue

          if not all_entries:
              requests.post(os.environ['WECHAT_WEBHOOK'], json={"msgtype": "text", "text": {"content": "ğŸ¤– AIæƒ…æŠ¥å‘˜ï¼šä»Šæ—¥æš‚æ— æ–°çš„å·¥å…·å‘å¸ƒæˆ–è¯¾ç¨‹æ›´æ–°ã€‚"}})
              exit()

          # 2. å‡†å¤‡æ¨é€å†…å®¹
          final_message = "ğŸ› ï¸ AI å®æˆ˜è¿›é˜¶ & å®ç”¨å·¥å…·å‘¨æŠ¥\n\n"

          # 3. è°ƒç”¨ AI è¿›è¡Œæ·±åº¦æ€»ç»“ï¼ˆå–å‰ 4 æ¡æœ€æœ‰ä»·å€¼çš„ï¼‰
          for entry in all_entries[:4]:
              title_en = entry.title
              summary_raw = entry.get('summary', 'No summary provided')
              summary_en = BeautifulSoup(summary_raw, "html.parser").get_text()[:500]
              link = entry.link
              
              try:
                  resp = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {os.environ['AI_API_KEY']}"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [
                              {
                                  "role": "system", 
                                  "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ AI æŠ€æœ¯æ•™ç»ƒã€‚è¯·å°†æä¾›çš„ AI å†…å®¹ç¿»è¯‘å¹¶æ€»ç»“æˆä¸­æ–‡ã€‚é‡ç‚¹é˜è¿°ï¼š1. è¿™æ˜¯ä»€ä¹ˆå·¥å…·æˆ–è¯¾ç¨‹ï¼Ÿ2. å®ƒèƒ½è§£å†³ä»€ä¹ˆå®é™…é—®é¢˜ï¼Ÿ3. é€‚åˆè°ä½¿ç”¨/å­¦ä¹ ã€‚è¯·ç›´æ¥æ’ç‰ˆï¼Œä¸¥ç¦ä½¿ç”¨ ** æˆ– # ç­‰ä»»ä½• Markdown ç¬¦å·ã€‚"
                              },
                              {"role": "user", "content": f"Title: {title_en}\nSummary: {summary_en}"}
                          ]
                      },
                      timeout=30
                  )
                  ai_result = resp.json()['choices'][0]['message']['content']
                  # äºŒæ¬¡æ¸…ç† Markdown
                  ai_result = ai_result.replace("**", "").replace("### ", "").replace("# ", "").replace("`", "")
              except Exception as e:
                  ai_result = f"é¡¹ç›®æ ‡é¢˜: {title_en}\n(AI æ·±åº¦åˆ†ææ¥å£è°ƒç”¨å¼‚å¸¸)"

              final_message += f"{ai_result}\nğŸ”— é“¾æ¥: {link}\n\n----------------\n"

          # 4. å‘é€è‡³ä¼ä¸šå¾®ä¿¡/æœºå™¨äºº
          requests.post(
              os.environ['WECHAT_WEBHOOK'],
              json={
                  "msgtype": "text",
                  "text": {
                      "content": final_message
                  }
              }
          )
          print("æ¨é€å·²å‘é€ï¼")
          EOF
