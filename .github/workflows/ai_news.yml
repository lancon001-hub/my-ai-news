name: AI News Translator & Push

on:
  schedule:
    - cron: '0 1 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 è¿è¡Œ
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæµ‹è¯•

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests

      - name: Run News Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os

          # 1. å°è¯•æŠ“å–å¤šä¸ªèµ„è®¯æº
          urls = [
              "https://www.theverge.com/ai-artificial-intelligence/rss/index.xml",
              "https://www.wired.com/feed/tag/ai/latest/rss"
          ]
          
          all_entries = []
          for url in urls:
              try:
                  feed = feedparser.parse(url)
                  if feed.entries:
                      all_entries.extend(feed.entries[:3])
              except:
                  continue

          # 2. å‡†å¤‡æ¨é€å†…å®¹
          if not all_entries:
              final_message = "ğŸ¤– **AI æƒ…æŠ¥å‘˜ï¼š** ç³»ç»Ÿè¿æ¥æ­£å¸¸ï¼Œä½†å½“å‰å„å¤–åª’é¢‘é“æš‚æ— æœ€æ–° AI èµ„è®¯æ›´æ–°ï¼Œæˆ‘ä¼šæŒç»­ç›‘æ§ã€‚"
          else:
              final_message = "ğŸ¤– **AI è¡Œä¸šæœ€æ–°èµ„è®¯ (è‡ªåŠ¨ç¿»è¯‘)**\n\n"
              for entry in all_entries[:3]: # å–å‰3æ¡æœ€ç²¾ç®€çš„
                  title_en = entry.title
                  link = entry.link
                  
                  try:
                      resp = requests.post(
                          "https://api.deepseek.com/chat/completions",
                          headers={"Authorization": f"Bearer {os.environ['AI_API_KEY']}"},
                          json={
                              "model": "deepseek-chat",
                              "messages": [
                                  {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç§‘æŠ€ç¿»è¯‘åŠ©æ‰‹ï¼Œè¯·å°†ä¸‹æ–¹çš„ AI æ–°é—»æ ‡é¢˜ç¿»è¯‘æˆä¸­æ–‡ã€‚ä»…è¾“å‡ºç¿»è¯‘ç»“æœã€‚"},
                                  {"role": "user", "content": title_en}
                              ]
                          },
                          timeout=20
                      )
                      title_cn = resp.json()['choices'][0]['message']['content']
                  except Exception as e:
                      title_cn = f"ï¼ˆç¿»è¯‘ç•¥è¿‡ï¼‰{title_en}"

                  final_message += f"ğŸ”¹ **{title_cn}**\nğŸ”— [æŸ¥çœ‹åŸæ–‡]({link})\n\n"

          # 3. æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡
          requests.post(
              os.environ['WECHAT_WEBHOOK'],
              json={"msgtype": "markdown", "markdown": {"content": final_message}}
          )
          EOF
