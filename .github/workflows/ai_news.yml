name: AI News Summarizer & Push

on:
  schedule:
    - cron: '0 1 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 è¿è¡Œ
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests beautifulsoup4

      - name: Run News Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os
          from bs4 import BeautifulSoup

          # 1. æŠ“å–èµ„è®¯æº
          url = "https://www.theverge.com/ai-artificial-intelligence/rss/index.xml"
          feed = feedparser.parse(url)
          
          if not feed.entries:
              requests.post(os.environ['WECHAT_WEBHOOK'], json={"msgtype": "text", "text": {"content": "ä»Šæ—¥æš‚æ—  AI èµ„è®¯æ›´æ–°"}})
              exit()

          final_message = "ğŸ¤– **AI è¡Œä¸šæƒ…æŠ¥ (æ·±åº¦æ€»ç»“ç‰ˆ)**\n\n---\n"

          # 2. å¾ªç¯å¤„ç†å‰ 3 æ¡æ–°é—»
          for entry in feed.entries[:3]:
              title_en = entry.title
              # è·å–æ‘˜è¦å¹¶å»é™¤ HTML æ ‡ç­¾
              summary_en = BeautifulSoup(entry.summary, "html.parser").get_text() if 'summary' in entry else "No summary available"
              link = entry.link
              
              try:
                  # è°ƒç”¨ AI è¿›è¡Œâ€œç¿»è¯‘+æ‘˜è¦â€
                  resp = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {os.environ['AI_API_KEY']}"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [
                              {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ AI ç§‘æŠ€è®°è€…ã€‚è¯·å°†ä¸‹é¢çš„è‹±æ–‡æ–°é—»æ ‡é¢˜ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶æ ¹æ®æ‘˜è¦å†…å®¹ï¼Œæ€»ç»“å‡º 2-3 å¥ä¸­æ–‡æ ¸å¿ƒè¦ç‚¹ã€‚è¦æ±‚ï¼šç”¨è¯é€šä¿—ã€æ’ç‰ˆæ•´é½ã€‚"},
                              {"role": "user", "content": f"Title: {title_en}\nSummary: {summary_en}"}
                          ]
                      },
                      timeout=30
                  )
                  ai_result = resp.json()['choices'][0]['message']['content']
              except:
                  ai_result = f"ã€æ ‡é¢˜ç¿»è¯‘ã€‘{title_en}\n(æ‘˜è¦æ€»ç»“å¤±è´¥)"

              final_message += f"{ai_result}\nğŸ”— [åŸæ–‡é“¾æ¥]({link})\n\n---\n"

          # 3. æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡
          requests.post(
              os.environ['WECHAT_WEBHOOK'],
              json={"msgtype": "markdown", "markdown": {"content": final_message}}
          )
          EOF
