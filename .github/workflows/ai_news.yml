name: AI News Final Pro

on:
  schedule:
    - cron: '08 0 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæµ‹è¯•

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install feedparser requests beautifulsoup4

      - name: Run News Bot
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os
          from bs4 import BeautifulSoup

          # 1. ç›‘æ§å¤šä¸ªé¡¶çº§ AI èµ„è®¯æºï¼Œç¡®ä¿ä¸è½ç©º
          sources = [
              "https://www.theverge.com/ai-artificial-intelligence/rss/index.xml",
              "https://techcrunch.com/category/artificial-intelligence/feed/",
              "https://openai.com/news/rss.xml"
          ]
          
          all_entries = []
          for url in sources:
              try:
                  feed = feedparser.parse(url)
                  if feed.entries:
                      # æ¯ä¸ªæºå–æœ€æ–°çš„ 2 æ¡
                      all_entries.extend(feed.entries[:2])
              except:
                  continue

          if not all_entries:
              requests.post(os.environ['WECHAT_WEBHOOK'], json={"msgtype": "text", "text": {"content": "ğŸ¤– AIæƒ…æŠ¥å‘˜ï¼šå…¨ç½‘æœå¯»å®Œæ¯•ï¼Œå½“å‰æš‚æ— é‡å¤§æ–°åŠ¨æ€ã€‚"}})
              exit()

          # 2. å‡†å¤‡æ¨é€å†…å®¹ï¼ˆå®Œå…¨ä¸ä½¿ç”¨ Markdown ç¬¦å·ï¼Œç¡®ä¿æ™®é€šå¾®ä¿¡ç›´æ˜¾ï¼‰
          final_message = "ğŸš€ AI è¡Œä¸šæ·±åº¦å†…å‚ (ç²¾ç®€ç‰ˆ)\n\n"

          # 3. å¤„ç†å‰ 4 æ¡æœ€é‡è¦çš„æ–°é—»
          for entry in all_entries[:4]:
              title_en = entry.title
              # è·å–æ‘˜è¦å¹¶æ¸…æ´— HTML
              summary_en = BeautifulSoup(entry.get('summary', 'No summary'), "html.parser").get_text()[:400]
              link = entry.link
              
              try:
                  # è°ƒç”¨ DeepSeek è¿›è¡Œâ€œç¿»è¯‘+æ€»ç»“â€
                  resp = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {os.environ['AI_API_KEY']}"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [
                              {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIç§‘æŠ€ä¸»ç¼–ã€‚è¯·å°†æä¾›çš„ AI æ–°é—»æ ‡é¢˜ç¿»è¯‘æˆå¸å¼•äººçš„ä¸­æ–‡ï¼Œå¹¶ç”¨ 3 ä¸ªè¦ç‚¹æ€»ç»“æ ¸å¿ƒä»·å€¼ã€‚è¯·ç›´æ¥ä½¿ç”¨æ–‡å­—å’Œæ¢è¡Œæ’ç‰ˆï¼Œç»å¯¹ä¸è¦ä½¿ç”¨ ** æˆ– # ç­‰ä»»ä½• Markdown ç¬¦å·ã€‚"},
                              {"role": "user", "content": f"Title: {title_en}\nSummary: {summary_en}"}
                          ]
                      },
                      timeout=30
                  )
                  ai_result = resp.json()['choices'][0]['message']['content']
                  # å†æ¬¡å¼ºåˆ¶è¿‡æ»¤å¯èƒ½å‡ºç°çš„ Markdown ç¬¦å·
                  ai_result = ai_result.replace("**", "").replace("### ", "").replace("# ", "")
              except:
                  ai_result = f"æ ‡é¢˜: {title_en}\n(ç¿»è¯‘åŠæ€»ç»“æš‚æ—¶ç¦»çº¿)"

              final_message += f"{ai_result}\nğŸ”— åŸæ–‡: {link}\n\n----------------\n"

          # 4. å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ text ç±»å‹å‘é€ï¼Œè§£å†³æ™®é€šå¾®ä¿¡æŠ¥é”™é—®é¢˜
          requests.post(
              os.environ['WECHAT_WEBHOOK'],
              json={
                  "msgtype": "text",
                  "text": {
                      "content": final_message
                  }
              }
          )
          print("æ¨é€å®Œæˆï¼")
          EOF
